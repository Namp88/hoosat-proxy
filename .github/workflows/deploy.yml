#!/bin/bash
set -e

echo "ğŸš€ Starting deployment..."
  
  # Navigate to project directory
cd /home/ubuntu/prod/hoosat-proxy
  
  # Check if user is in docker group, if not use sudo
if groups | grep -q '\bdocker\b'; then
DOCKER_CMD="docker"
COMPOSE_CMD="docker-compose"
else
DOCKER_CMD="sudo docker"
COMPOSE_CMD="sudo docker-compose"
fi
  
  # Pull latest image
echo "ğŸ“¦ Pulling latest Docker image..."
$COMPOSE_CMD -f docker-compose.prod.yml pull
  
  # Stop and remove old container
echo "ğŸ›‘ Stopping old container..."
$COMPOSE_CMD -f docker-compose.prod.yml down
  
  # Start new container
echo "â–¶ï¸  Starting new container..."
$COMPOSE_CMD -f docker-compose.prod.yml up -d
  
  # Wait for health check
echo "â³ Waiting for service to be healthy..."
sleep 10
  
  # Check if container is running
if [ "$($DOCKER_CMD ps -q -f name=hoosat-proxy)" ]; then
echo "âœ… Deployment successful!"
  
  # Show container logs
echo "ğŸ“‹ Recent logs:"
$DOCKER_CMD logs --tail 50 hoosat-proxy
else
echo "âŒ Deployment failed! Container is not running."
exit 1
fi
  
  # Clean up old images
echo "ğŸ§¹ Cleaning up old images..."
$DOCKER_CMD image prune -f

echo "ğŸ‰ Deployment completed!"